# RyuJIT: 次世代JITコンパイラ

原文： [RyuJIT: The next-generation JIT compiler][link01]

----

> この記事では.NETチームが作成している新しい64ビットJust-In-Time(JIT)コンパイラを紹介します。
> 執筆者はCLR Runtime PMチームのPMマネージャであるAndrew Pardoeです。

32ビット環境よりも必ずしも高速あるいは効率的ではないにもかかわらず、世の中のマシンは64ビット環境へと徐々に移行しています。
要因としては様々なものがありますが、多くのプログラムは64ビット環境よりも32ビット環境のほうが高速に動作します。
たとえば.NETの64ビットJITコンパイラがこれに該当します。
このJITコンパイラは作成したプログラムが高速に動作するように素晴らしい処理を行ってくれますが、このプログラム自体はそれほど高速ではありません。
そこでこのJITコンパイラの改善に着手しているというわけです。
新しい次世代のx64 JITコンパイラは従来の2倍の速度でコードをコンパイルするようになり、
64ビットの.NETコードに対する印象がきっと見違えるようになることでしょう。

## 64ビットに関する覚書

32ビットのx86コンピュータは太古の昔からそこにあったような感じさえします。
コンピュータアーキテクチャとしては大変素晴らしいものではあるのですが、1つだけ大きな問題があります。
32ビットポインタは4GBのRAMまでしかアドレスを指定できないという問題です。
64ビットコンピュータでワイドポインタを使用すれば、事実上無限の量のRAMを利用できます。
64ビットWindowsがリリースされた当初、RAMは比較的高価だったので、
64ビットマシンは基本的にはサーバ用途にしか使用されませんでした。
今日では64ビット環境がすっかり主流になり、マシンには4GB以上のRAMが普通に搭載されるようになりました。
インストール済みのRAMはせいぜい1GBですが、64ビットのスマートフォンさえ流通しています。

.NETの64ビットJITは元々長時間実行し続けるようなサーバ用プロセスに適したコードを生成するように設計されていました。
この動作は.NETのx86 JITとは異なります。
x86 JITはプログラムがなるべく高速に起動できるようなコードを生成するように設計されています。
64ビットの場合には主にサーバー用のコードを生成するため、コンパイルに時間がかかっても特に問題視されませんでした。
しかし今日では「サーバー用のコード」としては、高速に起動すべきWebアプリ用のコードも該当します。
.NETの現行の64ビットJITは必ずしも高速にコードをコンパイルするとは限りません。
そのため、プログラムの起動を高速化するためにはNGenやバックグラウンドJITのような別のテクノロジを使用しなければいけないわけです。

## そんな時にはRyuJIT!

Ryu何？
.NET Code GenerationチームはRyuJITというコードネームの新しい次世代x64コンパイラの開発を進めているところです。
この新しいJITは2倍高速です。
つまりRyuJITによってコンパイルされたアプリは30%高速に起動します。
（JITコンパイルにかかる時間はコンポーネントの起動時の1度だけなので、
JITが2倍高速になったとしてもアプリケーションが2倍高速に起動できるわけではありません。）
さらに、新しいJITは以前と変わらず、サーバープロセスとして長時間実行し続けることに適したコードを生成します。

以下のグラフは様々なサンプルコードに対して、JIT64とRyuJITのコンパイル時間(スループット)の割合を比較したものです。
各行はRyuJITがJIT64と比較してどのくらい高速かを表したもので、数値が大きいほど優れた結果を表します。
(訳注：画像は [元のサイト][link01] のものを転載しています)

![JIT64に対するRyuJITのパフォーマンス改善結果][link02]

サンプルコードはいずれもRyuJITのほうが高速にコンパイルされているわけですが、
特に2行目にあるRFC822 e-mail RegExの例に注目してください。
もはやチャートから見切れています！
これは、JIT64上では正規表現(RegEx)のパフォーマンスが極めて悪いことが原因です。
このベンチマークをJIT64上でコンパイルすると60秒かかり、メモリ使用量は最大1.4GBです。
一方RyuJITの場合、コンパイル時間は1.8行で、メモリ使用量は最大199MBです。

RyuJITが有効であることを示す一般例としてはPaint.NETのテストでしょう。
テスト用のマシン上では2.3秒の起動時間が1.8秒になりました。
これはつまりコンパイル時間がJIT64上では1510msかかったのに対して、RyuJITでは970msに短縮されたということです。
コンパイルが高速かつメモリ使用量が減少するわけなので、すべてのコードがより効率的に実行できるようになるというわけです。

## まだ完全ではありません

RyuJITによるパフォーマンスの向上とメモリ使用量の減少はとても素晴らしいものですが、
RyuJITはまだ完全ではありません。
JIT64が開発された当時、我々は動的にコンパイルを行うような状況に特化した
既存の32ビットx86のJITコンパイラを元にするのでは無く、
C++チームのコンパイラ最適化を元に開発を進めることに決めました。
多くの64ビットマシンはサーバー用途に使用されていたため、
コンパイラのスループットを向上するよりも、コンパイル後のコードのクオリティ向上に
注力するほうが自然でした。
しかしそうすることによって、.NET CodeGenチームは2つのコンパイラコードベースを
メンテナンスしなければならなくなったのです。
2つの場所に機能を追加（したり、バグを修正したり！）することにより、
イノベーションのペースも低下しました。
そこへさらにARMアーキテクチャやWindows Phone 8.0用のMDILも加わったため、
さらにメンテナンスが難しくなってしまいました。

RyuJITはx86 JITと同じコードベースを元にしています。
今のところはx64用しかありませんが、RyuJITは将来的には我々のすべての
JITコンパイラ、つまりx86やARM、MDIL、さらには今後作成されるであろう
コンパイラすべての基礎となるようなモダンコンパイラです。
コードベースが単一になることによって、.NETプログラムがアーキテクチャ間で
より整合性をとれるようになります。
別の言い方をすると、一般的にはバグに互換性が生じるようになります。
しかし単一のコードベースとすることによって、より迅速に新機能を追加できるようになり、
コード生成機能をより迅速に提供できるようになるのです。

## これを手に入れるためには？

RyuJITは今のところCTPとして公開されているため、非製品環境においてのみ試すことができます。
今のところ製品コードをサポートしてはいませんが、問題やバグ、挙動の変化などを発見した場合には是非報告していただければと思います。
フィードバッグや質問については ryujit@microsoft.com 宛にメールをください。
自分自身で問題の解決方法や回避方法が見つかった場合も是非教えていただければと思います。

[RyuJITのインストーラがダウンロードできます][link03]。
RyuJITは64ビットのWindows 8.1、またはWindows Server 2012 R2上でのみ動作します。
また、CTPをインストールしても環境が汚れてしまわないようにしたいと思っているため、
RyuJITをインストールしてもシステム上のNGenは更新されません。
最後に、コードの作成時にRyuJITを有効にすると、64ビットマシン上でEdit & Continueが
機能しなくなる点に注意してください。

インストールした後は、2通りの方法でRyuJITを有効化できます。
1つのアプリケーションに対してのみRyuJITを有効化したい場合、
環境変数を設定してください： ``COMPLUS_AltJit=*``
マシン全体で有効化する場合、レジストリキー ``HKLM\SOFTWARE\Microsoft\.NETFramework\AltJit`` に文字列「*」を設定してください。
いずれの方法でも、64bit CLRがJIT64の代わりにRyuJITを使用するようになります。
また、どちらも一時的な設定です。
RyuJITをインストールしただけではマシンに永続的な変更が行われません
（RyuJIT関連のファイルがディレクトリに置かれますが、それだけです）。

RyuJITがCTPからOne True .NET JIT Compiler&trade;に進化する過程については
このブログをチェックし続けてください。
もしもRyuJITの開発にギーク的な関心があって、より詳細な部分が知りたい場合には
[.NETのCodeGenブログ][link04] を参照するとよいでしょう。
そちらで質問への回答や設計の決定に関する説明を行っています。
(現時点でアクセスすると、不思議なコードネームに対する説明記事が読めます！)
また、CTPをダウンロードしてインストールした後は是非 ryujit@microsoft.com 宛にメールをください。
皆様からの声が届くことを期待しています！

[link01]: http://blogs.msdn.com/b/dotnet/archive/2013/09/30/ryujit-the-next-generation-jit-compiler.aspx "RyuJIT: The next-generation JIT compiler"
[link02]: img/Performance_Improvement_of_RyuJIT_over_JIT64.png
[link03]: http://aka.ms/RyuJIT "RyuJIT installer"
[link04]: http://blogs.msdn.com/b/clrcodegeneration/ ".NET CodeGen blog"
